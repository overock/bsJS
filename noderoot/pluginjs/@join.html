<%
if( !bs.session('id') ){
	var post = bs.SITE.application('post')( false, 'email', 's', 'pw', 's', 'nick', 's', 'thumb', 's' );
	console.log( post );
	if( post ) bs.SITE.application('db')( 'join', post, function( $data, $rs, $e ){
		if( $rs ){
			bs.WEB.application('db')( 'login', ['email', post.email, 'pw', post.pw], function( $data, $rs, $e ){
				if( $rs && $rs.length ){
					$rs = $rs[0];
					bs.$ck( 'savedid', $rs.email, '/', 100 ),
					$data.contents = {
						email:$rs.email,
						nick:$rs.nick,
						thumb:$rs.thumb
					},
					bs.WEB.session( 'id', $rs.member_rowid, 'email', $rs.email, 'nick', $rs.nick, 'thumb', $rs.thumb );
				}else $data.result = 'fail', $data.contents = $e.toString();
				bs.WEB.response( JSON.stringify( $data ) ), bs.WEB.next();
			} );
			return 1;
		}else $data.result = 'fail', $data.contents = $e.toString();
	} );
	else bs.WEB.response( JSON.stringify( {result:'fail', contents:'no post'} ) );
}else{
	bs.WEB.response( JSON.stringify( {
		result:'ok',
		contents:{
			email:bs.WEB.session('email'),
			nick:bs.WEB.session('nick'),
			thumb:bs.WEB.session('thumb')
		}
	} ) );
}
%>